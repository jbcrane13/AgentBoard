name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: SwiftLint
        # Runs without --strict while baseline violations are being cleared.
        # Violations appear as inline annotations on PR diffs.
        # Switch to --strict once violation count reaches zero.
        run: swiftlint lint --reporter github-actions-logging

      - name: Resolve Packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project AgentBoard.xcodeproj \
            -scheme AgentBoard

      - name: Build
        run: |
          set -o pipefail
          xcodebuild build \
            -project AgentBoard.xcodeproj \
            -scheme AgentBoard \
            -destination 'platform=macOS,arch=arm64' \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true
          xcodebuild build \
            -project AgentBoard.xcodeproj \
            -scheme AgentBoard \
            -destination 'platform=macOS,arch=arm64' \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      - name: Test (Unit — skip UITests)
        run: |
          xcodebuild test \
            -project AgentBoard.xcodeproj \
            -scheme AgentBoard \
            -destination 'platform=macOS,arch=arm64' \
            -skip-testing:AgentBoardUITests \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      - name: Check Coverage Threshold (≥ 30%)
        run: |
          COVERAGE=$(xcrun xccov view --report --json TestResults.xcresult 2>/dev/null | \
            python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          targets = [t for t in data.get('targets', []) if t.get('name', '') == 'AgentBoard']
          if targets:
              pct = targets[0]['lineCoverage'] * 100
              print('{:.1f}'.format(pct))
          else:
              print('0')
          " 2>/dev/null || echo "0")
          echo "AgentBoard line coverage: ${COVERAGE}%"
          python3 -c "
          import sys
          cov = float('${COVERAGE}')
          threshold = 30.0
          if cov < threshold:
              print('FAIL: {:.1f}% < {}% required'.format(cov, threshold))
              sys.exit(1)
          print('PASS: {:.1f}% >= {}%'.format(cov, threshold))
          "

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults.xcresult
          retention-days: 7
